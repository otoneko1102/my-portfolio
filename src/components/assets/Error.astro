---
interface Props {
  code: string;
  title: string;
  description?: string;
  icon?: string;
  variant?: 'default' | 'teapot';
  redirectAfter?: number; // sec
  redirectTo?: string;
  backText?: string;
}

const {
  code,
  title,
  description = '',
  icon,
  variant = 'default',
  redirectAfter,
  redirectTo = '/',
  backText = 'トップページへ戻る',
} = Astro.props as Props;
---

<div
  class={`error-container ${variant}`}
  role="region"
  aria-labelledby="error-title"
  data-redirect-after={typeof redirectAfter === 'number' ? redirectAfter : undefined}
  data-redirect-to={redirectTo}
>
  <div class="error-content">
    {icon && <div class="error-icon" aria-hidden="true">{icon}</div>}
    <h1 class="error-code">{code}</h1>
    <div class="message-card" role="group" aria-labelledby="error-title">
      <h2 id="error-title" class="error-message">{title}</h2>
      {description && <p class="error-description">{description}</p>}
      {typeof redirectAfter === 'number' && redirectAfter > 0 && (
        <p class="redirect-message">
          <span id="countdown">{redirectAfter}</span>秒後にトップページへリダイレクトします...
        </p>
      )}
      <a class="back-button gradient-btn" href={redirectTo}>{backText}</a>
    </div>
  </div>
</div>

{typeof redirectAfter === 'number' && redirectAfter > 0 && (
  <script is:inline>
    const container = document.querySelector('.error-container');
    const afterAttr = container?.getAttribute('data-redirect-after');
    const toAttr = container?.getAttribute('data-redirect-to') || '/';
    const after = Number(afterAttr);
    if (!Number.isNaN(after) && after > 0) {
      let countdown = after;
      const el = document.getElementById('countdown');
      const timer = setInterval(() => {
        countdown--;
        if (el) el.textContent = String(countdown);
        if (countdown <= 0) {
          clearInterval(timer);
          window.location.href = toAttr;
        }
      }, 1000);
    }
  </script>
)}

<style>
  .error-container {
    /* Errorページではfooterをfixedにするため、実際の固定高に合わせて上書き */
    --footer-height: 56px;
    height: calc(
      100dvh - var(--header-height) - var(--footer-height)
      - 4px
    );
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    overflow: hidden;
  }

  .error-container.default {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .error-container.teapot {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  .error-content {
    text-align: center;
    color: white;
    max-width: 560px;
    width: 100%;
    padding: 0 var(--spacing-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
  }

  .message-card {
    margin-top: var(--spacing-sm);
    background: rgba(255, 255, 255, 0.96);
    color: var(--color-text);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-md) var(--spacing-lg);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
    backdrop-filter: blur(2px);
  }

  .message-card .error-message,
  .message-card .error-description,
  .message-card .redirect-message { text-shadow: none; }

  .message-card .gradient-btn { margin-top: var(--spacing-sm); }

  .error-content > * { margin: 0; }

  .error-icon {
    font-size: 52px;
    margin-bottom: var(--spacing-xs);
    animation: steam 2s ease-in-out infinite;
  }

  @keyframes steam {
    0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
    50% { transform: translateY(-8px) scale(1.03); opacity: .9; }
  }

  .error-code {
    font-size: 60px;
    font-weight: 700;
    line-height: 1;
    text-shadow: 0 4px 20px rgba(0,0,0,.3);
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0) }
    50% { transform: translateY(-8px) }
  }

  .error-message {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin: var(--spacing-xs) 0;
    line-height: 1.15;
    text-shadow: 0 2px 10px rgba(0,0,0,.2);
  }

  .error-description {
    font-size: var(--font-size-xs);
    margin: var(--spacing-xs) 0;
    line-height: 1.4;
    opacity: .9;
  }

  .redirect-message {
    font-size: var(--font-size-xs);
    margin: var(--spacing-xs) 0;
    opacity: .85;
  }

  .gradient-btn {
    display: inline-block;
    margin-top: 0;
    padding: var(--spacing-xs) var(--spacing-sm);
    background: var(--brand-gradient);
    color: #ffffff;
    text-decoration: none;
    border-radius: var(--border-radius-full);
    font-weight: 700;
    font-size: var(--font-size-sm);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35);
    transition: transform var(--transition-normal), box-shadow var(--transition-normal), opacity var(--transition-normal);
  }

  .gradient-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 26px rgba(99,102,241,.45); opacity: .95; }

  @media (max-width: 768px) {
    .error-container {
      height: calc(100dvh - var(--header-height) - var(--footer-height) - 4px);
    }
    .error-icon { font-size: 44px; }
    .error-code { font-size: 48px; }
    .error-message { font-size: var(--font-size-base); }
    .message-card { padding: var(--spacing-sm) var(--spacing-md); }
  }

  :global(footer) {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    z-index: 10;
    margin-top: 0;
    padding: var(--spacing-2xs) var(--spacing-md);
  }
  :global(footer p) { font-size: var(--font-size-sm); }
</style>
